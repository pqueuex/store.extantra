<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>EXTANTRA - Premium Gaming & Music Themed Zippo Lighters | Collectible Horror & Electronic Music Designs</title>
    <meta name="description" content="Shop exclusive gaming and music themed Zippo lighters at EXTANTRA. Features Silent Hill horror designs, Aphex Twin electronic music, Elder Scrolls fantasy themes. Premium collectible lighters with authentic Zippo quality.">
    <meta name="keywords" content="gaming zippo lighters, horror themed lighters, Silent Hill zippo, Aphex Twin lighter, collectible zippo, premium zippo designs, gaming merchandise, horror collectibles, electronic music accessories">
    <meta name="author" content="EXTANTRA">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags for Social Media -->
    <meta property="og:title" content="EXTANTRA - Premium Gaming & Music Themed Zippo Lighters">
    <meta property="og:description" content="Exclusive collectible Zippo lighters featuring Silent Hill horror designs, Aphex Twin electronic music themes, and premium gaming artwork. Shop authentic Zippo quality with unique designs.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://store.extantra.net">
    <meta property="og:image" content="https://store.extantra.net/images/extantralogo.webp">
    <meta property="og:site_name" content="EXTANTRA">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="EXTANTRA - Premium Gaming & Music Themed Zippo Lighters">
    <meta name="twitter:description" content="Exclusive collectible Zippo lighters featuring gaming and music themes. Silent Hill, Aphex Twin, Elder Scrolls designs.">
    <meta name="twitter:image" content="https://store.extantra.net/images/extantralogo.webp">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://store.extantra.net">
    
    <!-- Favicon -->
    <link rel="icon" type="image/webp" href="images/extantralogo.webp">
    
    <link rel="stylesheet" href="styles.css">
    
    <!-- Structured Data for E-commerce Site -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "EXTANTRA",
      "url": "https://store.extantra.net",
      "description": "Premium gaming and music themed Zippo lighters featuring exclusive collectible designs",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://store.extantra.net/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Store",
      "name": "EXTANTRA",
      "description": "Premium collectible Zippo lighters with gaming and music themes",
      "url": "https://store.extantra.net",
      "logo": "https://store.extantra.net/images/extantralogo.webp",
      "image": "https://store.extantra.net/images/extantralogo.webp",
      "priceRange": "$30-$90",
      "paymentAccepted": "Credit Card, Visa, Mastercard, American Express",
      "currenciesAccepted": "USD",
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "US"
      }
    }
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-space">
                <img src="images/extantralogo.webp" alt="Extantra" class="logo-image">
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <div class="categories-section">
                    <div class="category" onclick="goToPage('index.html')">Home</div>
                    <div class="category" onclick="goToPage('about.html')">About</div>
                    <div class="category" onclick="goToPage('lighters.html')">Lighters</div>
                </div>
                <div class="cart-button" id="cart-button" onclick="toggleCartDropdown()">
                    Cart
                    <div class="cart-count-badge hidden" id="cart-badge">0</div>
                    <div class="cart-dropdown" id="cart-dropdown">
                        <div class="cart-dropdown-content">
                            <div class="cart-items" id="cart-items">
                                <!-- Cart items will be populated here -->
                            </div>
                            <div class="cart-summary">
                                <div>Items: <span id="cart-count">0</span></div>
                                <div class="cart-total-line">Subtotal: $<span id="cart-total">0.00</span></div>
                                <div class="cart-tax-line">Tax: $<span id="cart-tax">0.00</span></div>
                            </div>
                            <button class="dropdown-checkout-button" id="checkout-btn" onclick="goToCheckout()" disabled>
                                Checkout
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Filtering Controls -->
            <div class="filter-section">
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="sort-by">Sort:</label>
                        <select id="sort-by">
                            <option value="name">Name</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="category">Category</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-category">Category:</label>
                        <select id="filter-category">
                            <option value="">All</option>
                            <option value="gaming">Gaming</option>
                            <option value="music">Music</option>
                            <option value="original">Original</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-color">Color:</label>
                        <select id="filter-color">
                            <option value="">All</option>
                            <option value="chrome">Chrome</option>
                            <option value="black">Black</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filter-theme">Theme:</label>
                        <select id="filter-theme">
                            <option value="">All</option>
                            <option value="horror">Horror</option>
                            <option value="electronic">Electronic</option>
                            <option value="fantasy">Fantasy</option>
                            <option value="funny">Funny</option>
                        </select>
                    </div>
                    
                    <div class="filter-group checkbox-group">
                        <label>
                            <input type="checkbox" id="filter-instock" checked>
                            In Stock Only
                        </label>
                    </div>
                    
                    <div class="filter-group">
                        <button id="clear-filters" class="clear-filters-btn">Clear</button>
                    </div>
                </div>
            </div>

            <main class="product-grid" id="product-grid">
                <!-- Products will be dynamically loaded here -->
            </main>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="copyright">© 2025 EXTANTRA</div>
                <div class="contact">
                    <a href="mailto:store@extantra.net">Contact: store@extantra.net</a>
                </div>
                <div class="policy-link">
                    <a href="policy.html">Policy</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div class="modal-image" id="modal-image">
                Enlarged Product Image
            </div>
        </div>
    </div>

    <script>
        // Validate and sanitize cart data from localStorage
        function validateCartData(cartData) {
            try {
                if (!Array.isArray(cartData)) return [];
                
                return cartData.filter(item => {
                    return item && 
                           typeof item.name === 'string' && 
                           typeof item.price === 'number' && 
                           item.price > 0 && 
                           item.price < 10000 && // Reasonable price limit
                           typeof item.id !== 'undefined';
                }).map(item => ({
                    ...item,
                    name: String(item.name).substring(0, 100), // Limit name length
                    price: Math.max(0, Math.min(9999, Number(item.price))) // Sanitize price
                }));
            } catch (e) {
                console.error('Cart validation error:', e);
                return [];
            }
        }

        // Simplified cart initialization for debugging
        let cart = [];
        try {
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
                // Basic validation - just check if it's an array
                if (!Array.isArray(cart)) {
                    cart = [];
                }
            }
        } catch (e) {
            console.error('Error loading cart from localStorage:', e);
            cart = [];
        }
        
        let cartCount = cart.length;
        let cartTotal = cart.reduce((sum, item) => sum + (item.price || 0), 0);
        let products = []; // Will be loaded from JSON
        let sales = []; // Will be loaded from JSON
        let currentImageIndex = {}; // Track current image for each product by ID
        
        // Sales tax configuration
        const SALES_TAX_RATE = 0.085; // 8.5%
        let cartTax = cartTotal * SALES_TAX_RATE;

        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            updateCartDisplay();
            initializeFilters();
        });

        function initializeFilters() {
            // Add event listeners to all filter controls
            document.getElementById('sort-by').addEventListener('change', applyFiltersAndSort);
            document.getElementById('filter-category').addEventListener('change', applyFiltersAndSort);
            document.getElementById('filter-color').addEventListener('change', applyFiltersAndSort);
            document.getElementById('filter-theme').addEventListener('change', applyFiltersAndSort);
            document.getElementById('filter-instock').addEventListener('change', applyFiltersAndSort);
            document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
        }

        function applyFiltersAndSort() {
            let filteredProducts = [...products];
            
            // Apply filters
            const categoryFilter = document.getElementById('filter-category').value;
            const colorFilter = document.getElementById('filter-color').value;
            const themeFilter = document.getElementById('filter-theme').value;
            const instockFilter = document.getElementById('filter-instock').checked;
            
            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }
            
            if (colorFilter) {
                filteredProducts = filteredProducts.filter(p => {
                    if (Array.isArray(p.colors) && p.colors.length > 0) {
                        return p.colors.includes(colorFilter);
                    }
                    return p.color === colorFilter;
                });
            }
            
            if (themeFilter) {
                filteredProducts = filteredProducts.filter(p => p.theme === themeFilter);
            }
            
            if (instockFilter) {
                filteredProducts = filteredProducts.filter(p => p.inStock);
            }
            
            // Apply sorting
            const sortBy = document.getElementById('sort-by').value;
            switch (sortBy) {
                case 'name':
                    filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'price-low':
                    filteredProducts.sort((a, b) => a.currentPrice - b.currentPrice);
                    break;
                case 'price-high':
                    filteredProducts.sort((a, b) => b.currentPrice - a.currentPrice);
                    break;
                case 'category':
                    filteredProducts.sort((a, b) => a.category.localeCompare(b.category));
                    break;
            }
            
            renderFilteredProducts(filteredProducts);
        }

        function clearAllFilters() {
            document.getElementById('sort-by').value = 'name';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-color').value = '';
            document.getElementById('filter-theme').value = '';
            document.getElementById('filter-instock').checked = true;
            applyFiltersAndSort();
        }

        function renderFilteredProducts(filteredProducts) {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productGrid.innerHTML = '<div class="no-products">No products match your filters.</div>';
                return;
            }
            
            filteredProducts.forEach((product) => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-product-id', product.id);
                
                const hasMultipleImages = product.images && product.images.length > 1;
                const imageUrl = product.images && product.images.length > 0 ? product.images[0] : 'images/IMG_2179.jpeg';
                
                // Sanitize product data before rendering
                const sanitizeName = product.name.replace(/[<>]/g, '');
                const sanitizeDescription = (product.description || 'Quality product with great features').replace(/[<>]/g, '');
                const barcodeContent = product.barcode && product.barcode.includes('images/') 
                    ? `<img src="${product.barcode}" alt="Product barcode" class="barcode-image">`
                    : (product.barcode || '||||| ||| ||').replace(/[<>]/g, '');
                
                productCard.innerHTML = `
                    <div class="product-image" onclick="enlargeImage(${product.id})">
                        <img src="${imageUrl}" alt="${sanitizeName}" class="product-img">
                        ${product.onSale ? `<div class="sale-badge">${product.salePercentage}% OFF</div>` : ''}
                        ${hasMultipleImages ? `
                            <div class="image-nav image-nav-left">
                                <button class="nav-button" onclick="event.stopPropagation(); previousImage(${product.id})">&lt;</button>
                            </div>
                            <div class="image-nav image-nav-right">
                                <button class="nav-button" onclick="event.stopPropagation(); nextImage(${product.id})">&gt;</button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="product-info">
                        <div class="product-title clickable-title" onclick="goToProduct(${product.id})">${sanitizeName}</div>
                        <div class="product-description">${sanitizeDescription}</div>
                        <div class="barcode-space">${barcodeContent}</div>
                        <div class="product-pricing">
                            ${product.onSale ? `
                                <div class="sale-price">$${product.currentPrice.toFixed(2)}</div>
                                <div class="original-price">$${product.originalPrice.toFixed(2)}</div>
                            ` : `
                                <div class="product-price">$${product.currentPrice.toFixed(2)}</div>
                            `}
                        </div>
                        <button class="purchase-button" onclick="addToCart(${product.id})">Add to Cart</button>
                    </div>
                `;
                
                productGrid.appendChild(productCard);
            });
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                products = data.products;
                sales = data.sales || [];
                
                // Apply sales to products
                applyActiveSales();
                applyFiltersAndSort(); // Use filtering system instead of direct render
                
                // Initialize current image index for each product by ID
                products.forEach((product) => {
                    currentImageIndex[product.id] = 0;
                });
                
            } catch (error) {
                console.error('Error loading products:', error);
                // Fallback to placeholder products if JSON fails to load
                loadFallbackProducts();
            }
        }

        function applyActiveSales() {
            // Reset all sale prices first
            products.forEach(product => {
                const basePrice = typeof product.basePrice === 'number' ? product.basePrice : (product.currentPrice || product.originalPrice);
                product.salePrice = null;
                product.currentPrice = basePrice;
                product.onSale = false;
                product.salePercentage = 0;
                product.originalPrice = basePrice;
            });

            // Apply active sales
            sales.filter(sale => sale.active).forEach(sale => {
                products.forEach(product => {
                    if (matchesSaleCriteria(product, sale.criteria)) {
                        const salePrice = product.originalPrice * (1 - sale.percentage / 100);
                        product.salePrice = salePrice;
                        product.currentPrice = salePrice;
                        product.onSale = true;
                        product.salePercentage = sale.percentage;
                        product.saleName = sale.name;
                    }
                });
            });
        }

        function matchesSaleCriteria(product, criteria) {
            return Object.keys(criteria).every(key => {
                return product[key] === criteria[key];
            });
        }

        function loadFallbackProducts() {
            products = [
                { id: 1, name: 'Sample Product Title', originalPrice: 29.99, currentPrice: 29.99, images: ['images/001_silent_hill_2_zippo_lighter_1.jpeg'], description: 'High-quality item', barcode: 'images/barcodes/001.jpeg', type: 'lighter', color: 'chrome' },
                { id: 2, name: 'Another Product Name', originalPrice: 45.00, currentPrice: 45.00, images: ['images/002_aphex_twin_zippo_lighter_1.jpeg'], description: 'Premium quality', barcode: 'images/barcodes/002.jpeg', type: 'lighter', color: 'black' },
                { id: 3, name: 'Third Product', originalPrice: 19.95, currentPrice: 19.95, images: ['images/003_silent_hill_3_zippo_lighter_1.jpeg'], description: 'Great value', barcode: 'images/barcodes/003.jpeg', type: 'lighter', color: 'chrome' },
                { id: 4, name: 'Product Four', originalPrice: 35.50, currentPrice: 35.50, images: ['images/004_elder_scrolls_skyrim_zippo_lighter_1.jpeg'], description: 'Reliable choice', barcode: 'images/barcodes/004.jpeg', type: 'lighter', color: 'black' },
                { id: 5, name: 'Fifth Product Item', originalPrice: 22.99, currentPrice: 22.99, images: ['images/005_elder_scrolls_oblivion_zippo_lighter_1.jpeg'], description: 'Quality assured', barcode: 'images/barcodes/005.jpeg', type: 'lighter', color: 'chrome' },
                { id: 7, name: 'Sixth Product', originalPrice: 55.00, currentPrice: 55.00, images: ['images/007_need_head_blown_off_zippo_lighter_1.jpeg'], description: 'Premium option', barcode: 'images/barcodes/007.jpg', type: 'lighter', color: 'black' }
            ];
            sales = [];
            applyFiltersAndSort(); // Use filtering system instead of direct render
            
            // Initialize current image index for each product by ID
            products.forEach((product) => {
                currentImageIndex[product.id] = 0;
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const cartItem = {
                ...product,
                price: product.currentPrice,
                id: Date.now() + Math.random()
            };
            
            cart.push(cartItem);
            cartCount++;
            cartTotal += product.currentPrice;
            cartTax = cartTotal * SALES_TAX_RATE;

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
        }

        function removeFromCart(itemId) {
            const itemIndex = cart.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                const item = cart[itemIndex];
                cart.splice(itemIndex, 1);
                cartCount--;
                cartTotal -= item.price;
                cartTax = cartTotal * SALES_TAX_RATE;
                
                // Save to localStorage
                localStorage.setItem('cart', JSON.stringify(cart));
                
                updateCartDisplay();
            }
        }

        function goToProduct(productId) {
            window.location.href = `product.html?id=${productId}`;
        }

        function goToPage(url) {
            window.location.href = url;
        }

        // Navigate to checkout page
        function goToCheckout() {
            console.log('goToCheckout called, cartCount:', cartCount);
            if (cartCount > 0) {
                console.log('Redirecting to checkout.html');
                window.location.href = 'checkout.html';
            } else {
                console.log('Cart is empty, not redirecting');
            }
        }

        function updateCartDisplay() {
            document.getElementById('cart-count').textContent = cartCount;
            document.getElementById('cart-total').textContent = cartTotal.toFixed(2);
            document.getElementById('cart-tax').textContent = cartTax.toFixed(2);
            
            // Update badge
            const badge = document.getElementById('cart-badge');
            badge.textContent = cartCount;
            
            if (cartCount > 0) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            // Update cart items list
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                
                // Sanitize item name before rendering
                const sanitizedName = item.name.replace(/[<>]/g, '');
                
                itemElement.innerHTML = `
                    <div class="item-icon"></div>
                    <div class="item-details">
                        <div class="item-name">${sanitizedName}</div>
                        <div class="item-price">$${item.price.toFixed(2)}</div>
                    </div>
                    <div class="delete-item" onclick="removeFromCart(${item.id})">×</div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });
            
            // Enable checkout button if cart has items
            const checkoutBtn = document.getElementById('checkout-btn');
            checkoutBtn.disabled = cartCount === 0;
        }

        function toggleCartDropdown() {
            const dropdown = document.getElementById('cart-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const cartButton = document.getElementById('cart-button');
            const dropdown = document.getElementById('cart-dropdown');
            
            if (!cartButton.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        async function redirectToStripe() {
            if (cartCount === 0) return;

            try {
                // Send cart data to backend to create Stripe checkout session
                // Use the Node.js server URL (port 3000) instead of the current page's URL
                const serverUrl = 'http://localhost:3000/create-checkout-session';
                
                const response = await fetch(serverUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: cart
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const { url } = await response.json();
                
                // Redirect to Stripe checkout
                window.location.href = url;
                
            } catch (error) {
                console.error('Error creating checkout session:', error);
                alert('There was an error processing your checkout. Please try again.');
            }
        }

        // Image navigation functions
        function previousImage(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.images || product.images.length <= 1) return;
            
            // Decrease the current image index, wrap around if necessary
            currentImageIndex[productId] = (currentImageIndex[productId] - 1 + product.images.length) % product.images.length;
            
            // Update the image src using the product card with matching data-product-id
            const productCard = document.querySelector(`[data-product-id="${productId}"]`);
            if (productCard) {
                const img = productCard.querySelector('.product-img');
                img.src = product.images[currentImageIndex[productId]];
            }
        }

        function nextImage(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.images || product.images.length <= 1) return;
            
            // Increase the current image index, wrap around if necessary
            currentImageIndex[productId] = (currentImageIndex[productId] + 1) % product.images.length;
            
            // Update the image src using the product card with matching data-product-id
            const productCard = document.querySelector(`[data-product-id="${productId}"]`);
            if (productCard) {
                const img = productCard.querySelector('.product-img');
                img.src = product.images[currentImageIndex[productId]];
            }
        }

        // Image enlargement functions
        function enlargeImage(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            // Show the current image in the modal
            const currentImage = product.images && product.images.length > 0 
                ? product.images[currentImageIndex[productId] || 0] 
                : 'images/IMG_2179.jpeg';
            
            modalImage.innerHTML = `<img src="${currentImage}" alt="${product.name}">`;
            modal.classList.add('show');
            
            // Prevent body scrolling when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
            
            // Restore body scrolling
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside the image
        document.getElementById('image-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });

        // Enhanced keyboard navigation  
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('image-modal');
            const isModalOpen = modal.classList.contains('show');
            
            if (event.key === 'Escape' && isModalOpen) {
                closeModal();
            }
            // Note: Arrow key navigation for multiple images would need the current product context
            // This is primarily handled on individual product pages
        });
    </script>
</body>
</html>