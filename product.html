<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Dynamic SEO Meta Tags (updated by JavaScript) -->
    <title id="page-title">Premium Gaming & Music Themed Zippo Lighters - EXTANTRA</title>
    <meta name="description" id="page-description" content="Shop premium gaming and music themed Zippo lighters at EXTANTRA. Collectible designs featuring Silent Hill, Aphex Twin, Elder Scrolls themes with authentic Zippo quality.">
    <meta name="keywords" id="page-keywords" content="zippo lighter, gaming collectible, music themed lighter, premium zippo, collectible lighter">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" id="og-title" content="Premium Gaming & Music Themed Zippo Lighters - EXTANTRA">
    <meta property="og:description" id="og-description" content="Shop premium gaming and music themed Zippo lighters with collectible designs and authentic Zippo quality.">
    <meta property="og:type" content="product">
    <meta property="og:url" id="og-url" content="https://store.extantra.net/product.html">
    <meta property="og:image" id="og-image" content="https://store.extantra.net/images/extantralogo.webp">
    <meta property="og:site_name" content="EXTANTRA">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" id="twitter-title" content="Premium Gaming & Music Themed Zippo Lighters - EXTANTRA">
    <meta name="twitter:description" id="twitter-description" content="Shop premium gaming and music themed Zippo lighters with collectible designs.">
    <meta name="twitter:image" id="twitter-image" content="https://store.extantra.net/images/extantralogo.webp">
    
    <!-- Canonical URL -->
    <link rel="canonical" id="canonical-url" href="https://store.extantra.net/product.html">
    
    <link rel="stylesheet" href="styles.css">
    
    <!-- Trustpilot Widget Script -->
    <script type="text/javascript" src="//widget.trustpilot.com/bootstrap/v5/tp.widget.bootstrap.min.js" async></script>
    
    <!-- Structured Data for Product (will be populated by JavaScript) -->
    <script type="application/ld+json" id="product-structured-data">
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "name": "Premium Zippo Lighter",
      "description": "Premium gaming and music themed Zippo lighter",
      "brand": {
        "@type": "Brand",
        "name": "EXTANTRA"
      },
      "offers": {
        "@type": "Offer",
        "priceCurrency": "USD",
    "price": "35.00",
        "availability": "https://schema.org/InStock",
        "seller": {
          "@type": "Organization",
          "name": "EXTANTRA"
        }
      }
    }
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-space">
                <img src="images/extantralogo.webp" alt="Extantra" class="logo-image">
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <div class="categories-section">
                    <div class="category" onclick="goToPage('index.html')">Home</div>
                    <div class="category" onclick="goToPage('about.html')">About</div>
                    <div class="category" onclick="goToPage('lighters.html')">Lighters</div>
                </div>
                <div class="cart-button" id="cart-button" onclick="toggleCartDropdown()">
                    Cart
                    <div class="cart-count-badge hidden" id="cart-badge">0</div>
                    <div class="cart-dropdown" id="cart-dropdown">
                        <div class="cart-dropdown-content">
                            <div class="cart-items" id="cart-items">
                                <!-- Cart items will be populated here -->
                            </div>
                            <div class="cart-summary">
                                <div>Items: <span id="cart-count">0</span></div>
                                <div class="cart-total-line">Subtotal: $<span id="cart-total">0.00</span></div>
                                <div class="cart-tax-line">Tax: $<span id="cart-tax">0.00</span></div>
                            </div>
                            <button class="dropdown-checkout-button" id="checkout-btn" onclick="goToCheckout()" disabled>
                                Checkout
                            </button>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="product-page-content" id="product-content">
                <!-- Product content will be loaded here -->
                <div class="loading-message">Loading product...</div>
            </main>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="copyright">Â© 2025 EXTANTRA</div>
                <div class="contact">
                    <a href="mailto:store@extantra.net">Contact: store@extantra.net</a>
                </div>
                <div class="policy-link">
                    <a href="policy.html">Policy</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal" onclick="closeImageModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeImageModal()">&times;</button>
            <img class="modal-image" id="modal-image" src="" alt="Enlarged image">
        </div>
    </div>

    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let cartCount = cart.length;
        let cartTotal = cart.reduce((sum, item) => sum + item.price, 0);
        let currentProduct = null;
        let currentVariant = null;
        let currentImageIndex = 0;
        let products = [];
        let sales = [];
        let selectedCustomizations = {
            sideEngraving: { enabled: false, text: '' },
            backEngraving: { enabled: false, text: '' },
            butaneInsert: false
        };
        
        // Sales tax configuration
        const SALES_TAX_RATE = 0.085; // 8.5%
        let cartTax = cartTotal * SALES_TAX_RATE;

        function escapeHTML(str) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return String(str ?? '').replace(/[&<>"']/g, char => map[char]);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadProductFromURL();
            updateCartDisplay();
        });

        function loadProductFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (productId) {
                loadProduct(productId);
            } else {
                showError('No product specified');
            }
        }

        async function loadProduct(productId) {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                products = data.products;
                sales = data.sales || [];
                applyActiveSales();
                
                const product = products.find(p => p.id == productId);
                
                if (product) {
                    currentProduct = product;
                    const variants = Array.isArray(product.variants) ? product.variants : [];
                    currentVariant = variants.find(v => v.id === product.defaultVariantId) ||
                                     variants.find(v => v.color === 'chrome') ||
                                     variants[0] || null;
                    currentImageIndex = 0;
                    renderProductPage(product);
                    document.getElementById('page-title').textContent = `${product.name} - Extantra Net`;
                } else {
                    showError('Product not found');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showError('Error loading product');
            }
        }

        function applyActiveSales() {
            // Reset all sale prices first
            products.forEach(product => {
                product.salePrice = null;
                product.currentPrice = product.originalPrice;
                product.onSale = false;
                product.salePercentage = 0;
            });

            // Apply active sales
            sales.filter(sale => sale.active).forEach(sale => {
                products.forEach(product => {
                    if (matchesSaleCriteria(product, sale.criteria)) {
                        const salePrice = product.originalPrice * (1 - sale.percentage / 100);
                        product.salePrice = salePrice;
                        product.currentPrice = salePrice;
                        product.onSale = true;
                        product.salePercentage = sale.percentage;
                        product.saleName = sale.name;
                    }
                });
            });
        }

        function matchesSaleCriteria(product, criteria) {
            return Object.keys(criteria).every(key => {
                return product[key] === criteria[key];
            });
        }

        function updateSEOMetadata(product) {
            // Update page title
            const title = `${product.name} - Premium ${product.category} Zippo Lighter | EXTANTRA`;
            document.getElementById('page-title').textContent = title;
            
            // Update meta description
            const description = `${product.description} Shop this premium ${product.category} themed Zippo lighter at EXTANTRA. Starting at $${Math.min(...product.variants.map(v => v.price)).toFixed(2)} with free shipping on orders over $75.`;
            document.getElementById('page-description').setAttribute('content', description);
            
            // Update keywords
            const keywords = `${product.name}, ${product.category} zippo, ${product.theme} lighter, collectible zippo, premium zippo, gaming merchandise, zippo variants`;
            document.getElementById('page-keywords').setAttribute('content', keywords);
            
            // Update Open Graph meta tags
            document.getElementById('og-title').setAttribute('content', title);
            document.getElementById('og-description').setAttribute('content', description);
            document.getElementById('og-url').setAttribute('content', `https://store.extantra.net/product.html?id=${product.id}`);
            const primaryMedia = (Array.isArray(currentProduct?.images) && currentProduct.images.length > 0)
                ? currentProduct.images[0]
                : (Array.isArray(currentVariant?.images) && currentVariant.images.length > 0 ? currentVariant.images[0] : 'images/extantralogo.webp');
            const absolutePrimaryMedia = primaryMedia.startsWith('http') ? primaryMedia : `https://store.extantra.net/${primaryMedia}`;
            document.getElementById('og-image').setAttribute('content', absolutePrimaryMedia);
            
            // Update Twitter Card meta tags
            document.getElementById('twitter-title').setAttribute('content', title);
            document.getElementById('twitter-description').setAttribute('content', description);
            document.getElementById('twitter-image').setAttribute('content', absolutePrimaryMedia);
            
            // Update canonical URL
            document.getElementById('canonical-url').setAttribute('href', `https://store.extantra.net/product.html?id=${product.id}`);
            
            // Update structured data
            updateStructuredData(product);
        }

        function updateStructuredData(product) {
            const imageList = (Array.isArray(currentProduct?.images) && currentProduct.images.length > 0
                ? currentProduct.images
                : (Array.isArray(currentVariant?.images) && currentVariant.images.length > 0 ? currentVariant.images : ['images/extantralogo.webp']))
                .map(image => image.startsWith('http') ? image : `https://store.extantra.net/${image}`);

            const structuredData = {
                "@context": "https://schema.org",
                "@type": "Product",
                "name": product.name,
                "description": product.longDescription || product.description,
                "image": imageList,
                "brand": {
                    "@type": "Brand",
                    "name": "EXTANTRA"
                },
                "category": product.category,
                "offers": {
                    "@type": "Offer",
                    "priceCurrency": "USD",
                    "price": currentVariant.price.toFixed(2),
                    "availability": product.inStock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
                    "seller": {
                        "@type": "Organization",
                        "name": "EXTANTRA",
                        "url": "https://store.extantra.net"
                    },
                    "shippingDetails": {
                        "@type": "OfferShippingDetails",
                        "shippingRate": {
                            "@type": "MonetaryAmount",
                            "value": "0.00",
                            "currency": "USD"
                        },
                        "deliveryTime": {
                            "@type": "ShippingDeliveryTime",
                            "businessDays": {
                                "@type": "OpeningHoursSpecification",
                                "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
                            },
                            "cutoffTime": "16:00",
                            "handlingTime": {
                                "@type": "QuantitativeValue",
                                "minValue": 1,
                                "maxValue": 2,
                                "unitCode": "DAY"
                            },
                            "transitTime": {
                                "@type": "QuantitativeValue",
                                "minValue": 4,
                                "maxValue": 7,
                                "unitCode": "DAY"
                            }
                        }
                    }
                },
                "aggregateRating": {
                    "@type": "AggregateRating",
                    "ratingValue": "4.8",
                    "reviewCount": "25"
                }
            };
            
            document.getElementById('product-structured-data').textContent = JSON.stringify(structuredData, null, 2);
        }

        function renderProductPage(product) {
            const contentElement = document.getElementById('product-content');
            currentProduct = product;
            
            const variants = Array.isArray(product.variants) ? product.variants : [];
            if (!currentVariant || !variants.some(variant => variant.id === currentVariant.id)) {
                currentVariant = variants.find(variant => variant.id === product.defaultVariantId) ||
                                 variants.find(variant => variant.color === 'chrome') ||
                                 variants[0] || null;
            }
            
            if (!currentVariant) {
                showError('Product variant unavailable');
                return;
            }
            
            selectedCustomizations = {
                sideEngraving: { enabled: false, text: '' },
                backEngraving: { enabled: false, text: '' },
                butaneInsert: false
            };
            
            const variantImages = Array.isArray(currentVariant.images) ? currentVariant.images.filter(Boolean) : [];
            const fallbackImage = 'images/extantralogo.webp';
            const gifSource = currentVariant.gif || '';
            const mediaSources = [...variantImages];
            let gifIndex = -1;
            if (gifSource) {
                mediaSources.push(gifSource);
                gifIndex = mediaSources.length - 1;
            }
            const hasMedia = mediaSources.length > 0;
            const displaySources = hasMedia ? mediaSources : [fallbackImage];
            currentProduct.images = [...displaySources];
            currentProduct.hasMedia = hasMedia;
            currentProduct.gifIndex = hasMedia ? gifIndex : -1;
            currentImageIndex = 0;
            
            const safeName = escapeHTML(product.name);
            const safeDescription = escapeHTML(product.description);
            const mainImageSrc = escapeHTML(displaySources[0] || fallbackImage);
            const mainImageAlt = escapeHTML((hasMedia && currentProduct.gifIndex === 0) ? `${product.name} animated view` : product.name);
            const showNavigation = hasMedia && displaySources.length > 1;
            const thumbnailsHTML = hasMedia
                ? displaySources.map((src, index) => {
                    const isGif = index === currentProduct.gifIndex;
                    const altText = isGif ? `${product.name} animated view` : `${product.name} image ${index + 1}`;
                    return `<img src="${escapeHTML(src)}" alt="${escapeHTML(altText)}" class="thumbnail ${index === 0 ? 'active' : ''} ${isGif ? 'gif-thumbnail' : ''}" data-media-index="${index}" onclick="selectImage(${index})">`;
                }).join('')
                : `<div class="thumbnail placeholder">Media coming soon</div>`;
            const themeLabel = escapeHTML(product.theme ? product.theme.charAt(0).toUpperCase() + product.theme.slice(1) : 'â');
            const categoryLabel = escapeHTML(product.category ? product.category.charAt(0).toUpperCase() + product.category.slice(1) : 'â');
            const availabilityText = escapeHTML(product.inStock ? 'In Stock' : 'Preorder');
            const variantColorNames = variants.map(variant => variant.colorName).filter(Boolean);
            const colorLabel = escapeHTML(variantColorNames.length > 0 ? variantColorNames.join(', ') : (currentVariant.colorName || ''));
            const barcodeSrc = escapeHTML(product.barcode || '');
            const basePrice = Number(currentVariant.price || product.basePrice || 0);
            const highestPrice = Number(product.highestVariantPrice || basePrice);
            const priceRangeCopy = highestPrice > basePrice
                ? `Variants from $${basePrice.toFixed(2)} to $${highestPrice.toFixed(2)}`
                : `Base price $${basePrice.toFixed(2)}`;
            const priceRangeText = escapeHTML(priceRangeCopy);
            const customizationData = product.customization || {};
            currentProduct.customization = customizationData;
            const hasSideEngraving = Boolean(customizationData.sideEngraving);
            const hasBackEngraving = Boolean(customizationData.backEngraving);
            const sideEngravingPrice = hasSideEngraving ? Number(customizationData.sideEngraving.price || 0) : 0;
            const backEngravingPrice = hasBackEngraving ? Number(customizationData.backEngraving.price || 0) : 0;
            const customizationAvailable = hasSideEngraving || hasBackEngraving;
            const sideMaxCharacters = customizationData.sideEngraving?.maxCharacters || 50;
            const backMaxCharacters = customizationData.backEngraving?.maxCharacters || 50;
            const sideEngravingName = escapeHTML(customizationData.sideEngraving?.name || 'Side Engraving');
            const backEngravingName = escapeHTML(customizationData.backEngraving?.name || 'Back Engraving');
            const sideEngravingDescription = escapeHTML(customizationData.sideEngraving?.description || 'Add custom text to the side');
            const backEngravingDescription = escapeHTML(customizationData.backEngraving?.description || 'Add custom text to the back');
            const butaneInsertPrice = Number(currentVariant.premiumOptions?.butaneInsert?.price ?? 25);
            const initialTotal = calculateTotalPrice().toFixed(2);
            const formattedBasePrice = basePrice.toFixed(2);
            const longDescriptionParagraphs = String(product.longDescription || '').split('\n').map(paragraph => paragraph.trim()).filter(Boolean);
            const longDescriptionHTML = longDescriptionParagraphs.map(paragraph => `<p class="long-description">${escapeHTML(paragraph)}</p>`).join('');
            const stockStatusText = escapeHTML(currentVariant.inStock ? 'â In Stock' : 'â Out of Stock');
            const stockStatusClass = currentVariant.inStock ? 'in-stock' : 'out-of-stock';
            const customizationSectionHTML = customizationAvailable ? `
                <div class="info-card customization-section">
                    <h3>Custom Engraving</h3>
                    ${hasSideEngraving ? `
                    <label class="engraving-option">
                        <span class="inline-control">
                            <input type="checkbox" id="side-engraving" onchange="toggleSideEngraving()">
                            <span class="engraving-name">${sideEngravingName}</span>
                        </span>
                        <span class="engraving-price">+$${sideEngravingPrice.toFixed(2)}</span>
                    </label>
                    <div class="engraving-input" id="side-engraving-input" style="display: none;">
                        <input type="text" placeholder="Enter custom text (max ${sideMaxCharacters} characters)" maxlength="${sideMaxCharacters}" id="side-text" oninput="updatePricing()">
                        <small>${sideEngravingDescription}</small>
                    </div>
                    ` : ''}
                    ${hasBackEngraving ? `
                    <label class="engraving-option">
                        <span class="inline-control">
                            <input type="checkbox" id="back-engraving" onchange="toggleBackEngraving()">
                            <span class="engraving-name">${backEngravingName}</span>
                        </span>
                        <span class="engraving-price">+$${backEngravingPrice.toFixed(2)}</span>
                    </label>
                    <div class="engraving-input" id="back-engraving-input" style="display: none;">
                        <input type="text" placeholder="Enter custom text (max ${backMaxCharacters} characters)" maxlength="${backMaxCharacters}" id="back-text" oninput="updatePricing()">
                        <small>${backEngravingDescription}</small>
                    </div>
                    ` : ''}
                </div>
            ` : `
                <div class="info-card customization-section disabled">
                    <h3>Custom Engraving</h3>
                    <p class="customization-unavailable">Custom engraving isnât offered for this variant.</p>
                </div>
            `;
            
            // Update SEO metadata
            updateSEOMetadata(product);
            
            contentElement.innerHTML = `
                <div class="product-page">
                    <button class="back-button" onclick="goToPage('index.html')">&larr; Back to Products</button>
                    
                    <div class="product-detail-grid">
                        <div class="product-images-section">
                            <div class="main-product-image media-card" onclick="enlargeImage()">
                                <img src="${mainImageSrc}" alt="${mainImageAlt}" class="main-product-img" id="main-image">
                                <div class="image-nav image-nav-left" ${showNavigation ? '' : 'style="display: none;"'}>
                                    <button class="nav-button" onclick="event.stopPropagation(); previousImage()">&lt;</button>
                                </div>
                                <div class="image-nav image-nav-right" ${showNavigation ? '' : 'style="display: none;"'}>
                                    <button class="nav-button" onclick="event.stopPropagation(); nextImage()">&gt;</button>
                                </div>
                            </div>
                            <div class="image-thumbnails media-card" id="image-thumbnails">
                                ${thumbnailsHTML}
                            </div>
                        </div>
                        
                        <div class="product-info-section">
                            <div class="info-card info-header">
                                <h1 class="product-page-title">${safeName}</h1>
                                <p class="short-description">${safeDescription}</p>
                                <div class="product-meta-grid">
                                    <div><span>Theme:</span> ${themeLabel}</div>
                                    <div><span>Category:</span> ${categoryLabel}</div>
                                    <div><span>Colors:</span> ${colorLabel}</div>
                                    <div><span>Availability:</span> ${availabilityText}</div>
                                </div>
                                <div class="product-range-note">${priceRangeText}</div>
                                ${barcodeSrc ? `<div class="product-barcode"><img src="${barcodeSrc}" alt="Product barcode" class="barcode-image"></div>` : ''}
                            </div>
                            
                            <div class="info-card variant-selection">
                                <h3>Color</h3>
                                <div class="color-options">
                                    ${variants.map(variant => `
                                        <label class="color-option ${variant.id === currentVariant.id ? 'selected' : ''}">
                                            <input type="radio" name="color" value="${variant.id}" ${variant.id === currentVariant.id ? 'checked' : ''} onchange="selectVariant('${variant.id}')">
                                            <span class="color-name">${escapeHTML(variant.colorName)}</span>
                                            <span class="color-price">$${Number(variant.price || 0).toFixed(2)}</span>
                                        </label>
                                    `).join('')}
                                </div>
                                <div class="variant-disclaimer" id="variant-disclaimer" style="display: none;">
                                    <small class="disclaimer-text"></small>
                                </div>
                            </div>
                            
                            <div class="info-card pricing-section">
                                <h3>Pricing</h3>
                                <div class="product-page-price" id="total-price">$${initialTotal}</div>
                                <div class="price-breakdown" id="price-breakdown">
                                    <div>Base Price: $${formattedBasePrice}</div>
                                </div>
                            </div>
                            
                            <div class="info-card premium-options" id="premium-options" style="display: ${currentVariant.premiumOptions ? 'flex' : 'none'};">
                                <h3>Premium Upgrades</h3>
                                <label class="upgrade-option">
                                    <span class="inline-control">
                                        <input type="checkbox" id="butane-insert" onchange="toggleButaneInsert()">
                                        <span class="upgrade-name">Butane Torch Insert</span>
                                    </span>
                                    <span class="upgrade-price">+$${butaneInsertPrice.toFixed(2)}</span>
                                    <div class="upgrade-description">Upgrade to butane torch insert for reliable wind-resistant flame</div>
                                </label>
                            </div>
                            
                            ${customizationSectionHTML}
                            
                            <div class="info-card product-description-section">
                                <h3>Description</h3>
                                <p class="short-description">${safeDescription}</p>
                                ${longDescriptionHTML}
                            </div>
                            
                            <div class="info-card purchase-card">
                                <div class="purchase-section">
                                    <button class="add-to-cart-button" onclick="addToCart()" id="add-to-cart-btn">Add to Cart - $${initialTotal}</button>
                                    <div class="stock-status ${stockStatusClass}">${stockStatusText}</div>
                                    <div class="purchase-note">All lighters ship from Bradford, PA with tracking in under 48 hours.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reviews Section -->
                    <div class="reviews-section" id="reviews-section">
                        <div class="reviews-header">
                            <h2>Customer Reviews</h2>
                            <div class="reviews-summary" id="reviews-summary">
                                <!-- Reviews summary will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="reviews-tabs">
                            <button class="tab-button active" onclick="showReviewsTab('reviews')">Reviews</button>
                            <button class="tab-button" onclick="showReviewsTab('trustpilot')">Trustpilot</button>
                        </div>
                        
                        <div class="reviews-content">
                            <div class="tab-content active" id="reviews-tab">
                                <div class="reviews-list" id="reviews-list">
                                    <!-- Reviews will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="tab-content" id="trustpilot-tab">
                                <div class="trustpilot-widget">
                                    <p>See our verified reviews on Trustpilot:</p>
                                    
                                    <!-- Trustpilot widget -->
                                    <div class="trustpilot-reviews-widget">
                                        <div class="trustpilot-widget" data-locale="en-US" data-template-id="5419b6ffb0d04a076446a9af" data-businessunit-id="67151b8a3f3a8a4b8ec4e0ad" data-style-height="52px" data-style-width="100%">
                                            <a href="https://www.trustpilot.com/review/extantra.net" target="_blank" rel="noopener">Trustpilot</a>
                                        </div>
                                    </div>
                                    
                                    <div class="trustpilot-placeholder">
                                        <a href="https://www.trustpilot.com/review/extantra.net" target="_blank" class="trustpilot-link">
                                            Leave a Review on Trustpilot â
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load reviews after rendering the product
            loadProductReviews(product.id);
            
            // Update disclaimer visibility for initial variant
            updateDisclaimerVisibility();
        }

        function showError(message) {
            const contentElement = document.getElementById('product-content');
            contentElement.innerHTML = `
                <div class="error-message">
                    <h2>Error</h2>
                    <p>${message}</p>
                    <button onclick="goToPage('index.html')">Return to Products</button>
                </div>
            `;
        }

        // New variant and customization functions
        function selectVariant(variantId) {
            currentVariant = currentProduct.variants.find(v => v.id === variantId);
            if (!currentVariant) return;
            
            // Update images and GIF
            updateProductImages();
            
            // Update color selection UI
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            const selectedInput = document.querySelector(`input[name="color"][value="${variantId}"]`);
            if (selectedInput) {
                const option = selectedInput.closest('.color-option');
                if (option) {
                    option.classList.add('selected');
                }
            }
            
            // Show/hide premium options
            const premiumSection = document.getElementById('premium-options');
            if (premiumSection) {
                const butaneInput = document.getElementById('butane-insert');
                const priceLabel = premiumSection.querySelector('.upgrade-price');
                if (currentVariant.premiumOptions?.butaneInsert) {
                    premiumSection.style.display = 'flex';
                    if (priceLabel) {
                        priceLabel.textContent = `+$${Number(currentVariant.premiumOptions.butaneInsert.price || 0).toFixed(2)}`;
                    }
                } else {
                    premiumSection.style.display = 'none';
                    selectedCustomizations.butaneInsert = false;
                    if (butaneInput) {
                        butaneInput.checked = false;
                    }
                }
            }

            // Reset customization toggles when switching variants
            const sideCheckbox = document.getElementById('side-engraving');
            const sideInputDiv = document.getElementById('side-engraving-input');
            const sideInput = document.getElementById('side-text');
            if (sideCheckbox) {
                sideCheckbox.checked = false;
                selectedCustomizations.sideEngraving = { enabled: false, text: '' };
            }
            if (sideInputDiv) {
                sideInputDiv.style.display = 'none';
            }
            if (sideInput) {
                sideInput.value = '';
            }

            const backCheckbox = document.getElementById('back-engraving');
            const backInputDiv = document.getElementById('back-engraving-input');
            const backInput = document.getElementById('back-text');
            if (backCheckbox) {
                backCheckbox.checked = false;
                selectedCustomizations.backEngraving = { enabled: false, text: '' };
            }
            if (backInputDiv) {
                backInputDiv.style.display = 'none';
            }
            if (backInput) {
                backInput.value = '';
            }
            
            // Update disclaimer visibility
            updateDisclaimerVisibility();
            
            // Update pricing
            updatePricing();
        }

        function updateProductImages() {
            const fallbackImage = 'images/extantralogo.webp';
            const thumbnailsContainer = document.getElementById('image-thumbnails');
            const mainImage = document.getElementById('main-image');
            const variantImages = Array.isArray(currentVariant?.images) ? currentVariant.images.filter(Boolean) : [];
            const gifSource = currentVariant?.gif || '';
            const mediaSources = [...variantImages];
            let gifIndex = -1;
            if (gifSource) {
                mediaSources.push(gifSource);
                gifIndex = mediaSources.length - 1;
            }
            const hasMedia = mediaSources.length > 0;
            const displaySources = hasMedia ? mediaSources : [fallbackImage];

            currentImageIndex = 0;
            currentProduct.images = [...displaySources];
            currentProduct.hasMedia = hasMedia;
            currentProduct.gifIndex = hasMedia ? gifIndex : -1;

            if (mainImage) {
                const isGif = currentProduct.gifIndex === 0 && hasMedia;
                mainImage.src = displaySources[0] || fallbackImage;
                mainImage.alt = isGif ? `${currentProduct.name} animated view` : (hasMedia ? currentProduct.name : 'Product image coming soon');
            }

            if (thumbnailsContainer) {
                if (hasMedia) {
                    const safeName = escapeHTML(currentProduct.name);
                    thumbnailsContainer.innerHTML = displaySources.map((src, index) => {
                        const isGif = index === currentProduct.gifIndex;
                        const altText = isGif ? `${currentProduct.name} animated view` : `${currentProduct.name} image ${index + 1}`;
                        return `<img src="${escapeHTML(src)}" alt="${escapeHTML(altText)}" class="thumbnail ${index === 0 ? 'active' : ''} ${isGif ? 'gif-thumbnail' : ''}" data-media-index="${index}" onclick="selectImage(${index})">`;
                    }).join('');
                } else {
                    thumbnailsContainer.innerHTML = `<div class="thumbnail placeholder">Media coming soon</div>`;
                }
            }

            document.querySelectorAll('.image-nav').forEach(nav => {
                nav.style.display = hasMedia && displaySources.length > 1 ? 'flex' : 'none';
            });
        }

        function updateDisclaimerVisibility() {
            const disclaimerDiv = document.getElementById('variant-disclaimer');
            const disclaimerText = disclaimerDiv.querySelector('.disclaimer-text');
            
            if (currentVariant.disclaimer) {
                disclaimerText.textContent = currentVariant.disclaimer;
                disclaimerDiv.style.display = 'block';
            } else {
                disclaimerDiv.style.display = 'none';
            }
        }

        function toggleButaneInsert() {
            const checkbox = document.getElementById('butane-insert');
            if (!checkbox) return;
            selectedCustomizations.butaneInsert = checkbox.checked;
            updatePricing();
        }

        function toggleSideEngraving() {
            const checkbox = document.getElementById('side-engraving');
            const inputDiv = document.getElementById('side-engraving-input');
            if (!checkbox || !inputDiv) return;
            
            selectedCustomizations.sideEngraving.enabled = checkbox.checked;
            inputDiv.style.display = checkbox.checked ? 'block' : 'none';
            
            if (!checkbox.checked) {
                selectedCustomizations.sideEngraving.text = '';
                document.getElementById('side-text').value = '';
            }
            
            updatePricing();
        }

        function toggleBackEngraving() {
            const checkbox = document.getElementById('back-engraving');
            const inputDiv = document.getElementById('back-engraving-input');
            if (!checkbox || !inputDiv) return;
            
            selectedCustomizations.backEngraving.enabled = checkbox.checked;
            inputDiv.style.display = checkbox.checked ? 'block' : 'none';
            
            if (!checkbox.checked) {
                selectedCustomizations.backEngraving.text = '';
                document.getElementById('back-text').value = '';
            }
            
            updatePricing();
        }

        function calculateTotalPrice() {
            const basePrice = Number(currentVariant?.price || 0);
            let total = basePrice;
            
            if (selectedCustomizations.sideEngraving.enabled && currentProduct.customization?.sideEngraving) {
                total += Number(currentProduct.customization.sideEngraving.price || 0);
            }
            
            if (selectedCustomizations.backEngraving.enabled && currentProduct.customization?.backEngraving) {
                total += Number(currentProduct.customization.backEngraving.price || 0);
            }
            
            if (selectedCustomizations.butaneInsert && currentVariant.premiumOptions?.butaneInsert) {
                total += Number(currentVariant.premiumOptions.butaneInsert.price || 0);
            }
            
            return Number(total.toFixed(2));
        }

        function updatePricing() {
            // Update customization text
            selectedCustomizations.sideEngraving.text = document.getElementById('side-text')?.value || '';
            selectedCustomizations.backEngraving.text = document.getElementById('back-text')?.value || '';
            
            const total = calculateTotalPrice();
            
            // Update price display
            const formattedTotal = total.toFixed(2);
            document.getElementById('total-price').textContent = `$${formattedTotal}`;
            document.getElementById('add-to-cart-btn').textContent = `Add to Cart - $${formattedTotal}`;
            
            // Update price breakdown
            const breakdown = [`Base Price: $${Number(currentVariant?.price || 0).toFixed(2)}`];
            
            if (selectedCustomizations.sideEngraving.enabled) {
                breakdown.push(`Side Engraving: +$${Number(currentProduct.customization?.sideEngraving?.price || 0).toFixed(2)}`);
            }
            
            if (selectedCustomizations.backEngraving.enabled) {
                breakdown.push(`Back Engraving: +$${Number(currentProduct.customization?.backEngraving?.price || 0).toFixed(2)}`);
            }
            
            if (selectedCustomizations.butaneInsert && currentVariant.premiumOptions?.butaneInsert) {
                breakdown.push(`Butane Insert: +$${Number(currentVariant.premiumOptions.butaneInsert.price || 0).toFixed(2)}`);
            }
            
            document.getElementById('price-breakdown').innerHTML = breakdown.map(item => `<div>${item}</div>`).join('');
        }

        function selectImage(index) {
            const media = Array.isArray(currentProduct?.images) ? currentProduct.images : [];
            if (media.length === 0) return;
            
            const total = media.length;
            currentImageIndex = (index + total) % total;
            const mainImage = document.getElementById('main-image');
            if (mainImage) {
                const isGif = currentProduct.gifIndex === currentImageIndex;
                mainImage.src = media[currentImageIndex];
                mainImage.alt = isGif ? `${currentProduct.name} animated view` : currentProduct.name;
            }
            
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === currentImageIndex);
            });
        }

        function previousImage() {
            const media = Array.isArray(currentProduct?.images) ? currentProduct.images : [];
            if (media.length <= 1) return;
            selectImage(currentImageIndex - 1);
        }

        function nextImage() {
            const media = Array.isArray(currentProduct?.images) ? currentProduct.images : [];
            if (media.length <= 1) return;
            selectImage(currentImageIndex + 1);
        }

        function enlargeImage() {
            const media = Array.isArray(currentProduct?.images) ? currentProduct.images : [];
            if (media.length === 0) return;
            const currentImage = media[currentImageIndex] || media[0];
            openImageModal(currentImage);
        }

        function addToCart() {
            if (!currentProduct || !currentVariant) return;
            
            // Validate engraving text if enabled
            if (selectedCustomizations.sideEngraving.enabled && !selectedCustomizations.sideEngraving.text.trim()) {
                alert('Please enter text for side engraving or disable the option.');
                return;
            }
            
            if (selectedCustomizations.backEngraving.enabled && !selectedCustomizations.backEngraving.text.trim()) {
                alert('Please enter text for back engraving or disable the option.');
                return;
            }
            
            const cartItem = {
                id: Date.now() + Math.random(),
                productId: currentProduct.id,
                variantId: currentVariant.id,
                name: currentProduct.name,
                variantName: currentVariant.colorName,
                price: calculateTotalPrice(),
                basePrice: currentVariant.price,
                image: (Array.isArray(currentVariant.images) && currentVariant.images[0]) || '',
                customizations: {
                    sideEngraving: selectedCustomizations.sideEngraving.enabled && currentProduct.customization?.sideEngraving ? {
                        text: selectedCustomizations.sideEngraving.text,
                        price: Number(currentProduct.customization.sideEngraving.price || 0)
                    } : null,
                    backEngraving: selectedCustomizations.backEngraving.enabled && currentProduct.customization?.backEngraving ? {
                        text: selectedCustomizations.backEngraving.text,
                        price: Number(currentProduct.customization.backEngraving.price || 0)
                    } : null,
                    butaneInsert: selectedCustomizations.butaneInsert && currentVariant.premiumOptions?.butaneInsert ? {
                        price: Number(currentVariant.premiumOptions.butaneInsert.price || 0)
                    } : null
                }
            };
            
            cart.push(cartItem);
            cartCount++;
            cartTotal += cartItem.price;
            cartTax = cartTotal * SALES_TAX_RATE;
            
            // Save to localStorage
            localStorage.setItem('cart', JSON.stringify(cart));
            
            updateCartDisplay();
            
            // Show feedback
            const button = document.getElementById('add-to-cart-btn');
            const originalText = button.textContent;
            button.textContent = 'Added to Cart!';
            button.style.backgroundColor = '#4CAF50';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '';
            }, 1500);
        }

        function removeFromCart(itemId) {
            const itemIndex = cart.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                const item = cart[itemIndex];
                cart.splice(itemIndex, 1);
                cartCount--;
                cartTotal -= item.price;
                cartTax = cartTotal * SALES_TAX_RATE;
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }
        }

        function updateCartDisplay() {
            document.getElementById('cart-count').textContent = cartCount;
            document.getElementById('cart-total').textContent = cartTotal.toFixed(2);
            document.getElementById('cart-tax').textContent = cartTax.toFixed(2);
            
            const badge = document.getElementById('cart-badge');
            badge.textContent = cartCount;
            
            if (cartCount > 0) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.innerHTML = `
                    <div class="item-icon"></div>
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">$${item.price.toFixed(2)}</div>
                    </div>
                    <div class="delete-item" onclick="removeFromCart(${item.id})">Ã</div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });
            
            const checkoutBtn = document.getElementById('checkout-btn');
            checkoutBtn.disabled = cartCount === 0;
        }

        function toggleCartDropdown() {
            const dropdown = document.getElementById('cart-dropdown');
            dropdown.classList.toggle('show');
        }

        function goToPage(url) {
            window.location.href = url;
        }

        // Navigate to checkout page
        function goToCheckout() {
            console.log('goToCheckout called, cartCount:', cartCount);
            if (cartCount > 0) {
                console.log('Redirecting to checkout.html');
                window.location.href = 'checkout.html';
            } else {
                console.log('Cart is empty, not redirecting');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const cartButton = document.getElementById('cart-button');
            const dropdown = document.getElementById('cart-dropdown');
            
            if (!cartButton.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Enhanced keyboard navigation
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('image-modal');
            const isModalOpen = modal.classList.contains('show');
            
            if (event.key === 'Escape' && isModalOpen) {
                closeImageModal();
            } else if (isModalOpen && currentProduct && currentProduct.images && currentProduct.images.length > 1) {
                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    previousImage();
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    nextImage();
                }
            }
        });

        // Close modal when clicking outside the image
        document.getElementById('image-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeImageModal();
            }
        });

        // Review system functions
        async function loadProductReviews(productId) {
            try {
                const response = await fetch(`/api/reviews/product/${productId}`);
                const reviewsData = await response.json();
                
                displayReviewsSummary(reviewsData);
                displayReviewsList(reviewsData.reviews);
                
                // Update structured data with real review data
                updateReviewStructuredData(reviewsData);
            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviews-summary').innerHTML = '<p>Unable to load reviews</p>';
            }
        }

        function displayReviewsSummary(data) {
            const summaryElement = document.getElementById('reviews-summary');
            const averageRating = data.averageRating.toFixed(1);
            
            summaryElement.innerHTML = `
                <div class="rating-summary">
                    <div class="average-rating">
                        <span class="rating-number">${averageRating}</span>
                        <div class="stars">${renderStars(data.averageRating)}</div>
                        <span class="review-count">(${data.totalReviews} review${data.totalReviews !== 1 ? 's' : ''})</span>
                    </div>
                </div>
            `;
        }

        function displayReviewsList(reviews) {
            const reviewsListElement = document.getElementById('reviews-list');
            
            if (reviews.length === 0) {
                reviewsListElement.innerHTML = '<p class="no-reviews">No reviews yet. Be the first to review this product!</p>';
                return;
            }
            
            reviewsListElement.innerHTML = reviews.map(review => `
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <span class="reviewer-name">${review.customerName}</span>
                            <span class="review-date">${formatDate(review.date)}</span>
                            ${review.verified ? '<span class="verified-badge">Verified Purchase</span>' : ''}
                            <span class="review-source">${review.source === 'etsy' ? 'Etsy' : 'Website'}</span>
                        </div>
                        <div class="review-rating">${renderStars(review.rating)}</div>
                    </div>
                    <h4 class="review-title">${review.title}</h4>
                    <p class="review-text">${review.review}</p>
                    ${review.images && review.images.length > 0 ? `
                        <div class="review-images">
                            ${review.images.map(image => `
                                <img src="${image}" alt="Customer photo" class="review-image" onclick="openImageModal('${image}')" loading="lazy">
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            return 'â'.repeat(fullStars) + 
                   (hasHalfStar ? 'â' : '') + 
                   'â'.repeat(emptyStars);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function showReviewsTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            document.querySelector(`[onclick="showReviewsTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Star rating interaction
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('star')) {
                const rating = parseInt(event.target.dataset.rating);
                document.getElementById('review-rating').value = rating;
                
                // Update star display
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }
        });

        function updateReviewStructuredData(reviewsData) {
            if (reviewsData.totalReviews > 0) {
                const structuredDataElement = document.getElementById('product-structured-data');
                const currentData = JSON.parse(structuredDataElement.textContent);
                
                currentData.aggregateRating = {
                    "@type": "AggregateRating",
                    "ratingValue": reviewsData.averageRating.toFixed(1),
                    "reviewCount": reviewsData.totalReviews.toString()
                };
                
                // Add reviews to structured data
                currentData.review = reviewsData.reviews.slice(0, 5).map(review => ({
                    "@type": "Review",
                    "reviewRating": {
                        "@type": "Rating",
                        "ratingValue": review.rating.toString()
                    },
                    "author": {
                        "@type": "Person",
                        "name": review.customerName
                    },
                    "reviewBody": review.review,
                    "datePublished": review.date
                }));
                
                structuredDataElement.textContent = JSON.stringify(currentData, null, 2);
            }
        }

        // Image modal functionality
        function openImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            modalImg.src = imageSrc;
            if (currentProduct) {
                const mediaIndex = Array.isArray(currentProduct.images) ? currentProduct.images.indexOf(imageSrc) : -1;
                const isGif = mediaIndex > -1 && mediaIndex === currentProduct.gifIndex;
                modalImg.alt = isGif ? `${currentProduct.name} animated view` : `${currentProduct.name}`;
            } else {
                modalImg.alt = 'Enlarged product image';
            }
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside the image
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('image-modal');
            if (event.target === modal) {
                closeImageModal();
            }
        });
    </script>

</body>
</html>
